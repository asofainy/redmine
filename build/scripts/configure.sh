#!/bin/bash

HTTPS_PORT=3443
root="/usr/src/redmine"

### Permissions


sudo chown -R redmine:redmine /usr/src/redmine /usr/local/bundle/gems

### SSL

cd $root
mkdir -p ssl
cd ssl
openssl dhparam -out dhparam.pem 2048
openssl req -x509 -nodes -newkey rsa:4096 -keyout ssl_key.pem -out ssl_cert.pem -days 365 \
            -subj "/CN=${HOSTNAME}/O=Olympus/OU=Apollo/C=GR/L=GR"
cd -


cat > /usr/src/redmine/Passengerfile.json <<EOF
{
    "nginx_config_template": "/usr/src/redmine/config/nginx.conf.erb",
    "user": "redmine",
    "port": ${HTTPS_PORT},
    "ssl": true,
    "ssl_certificate": "/usr/src/redmine/ssl/ssl_cert.pem",
    "ssl_certificate_key": "/usr/src/redmine/ssl/ssl_key.pem",
    "environment": "${RAILS_ENV}"
}
EOF

#cp $(passenger-config about resourcesdir)/templates/standalone/config.erb /usr/src/redmine/config/nginx.conf.erb

cat > /usr/src/redmine/config/nginx.conf.erb <<EOF
##########################################################################
#  Passenger Standalone is built on the same technology that powers
#  Passenger for Nginx, so any configuration option supported by Passenger
#  for Nginx can be applied to Passenger Standalone as well. You can do
#  this by direct editing the Nginx configuration template that is used by
#  Passenger Standalone.
#
#  This file is the original template. DO NOT EDIT THIS FILE DIRECTLY.
#  Instead, make a copy of this file and pass the '--nginx-config-template'
#  parameter to Passenger Standalone.
#
#  Learn more about using the Nginx configuration template at:
#  https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template
#
#  *** NOTE ***
#  If you customize the template file, make sure you keep an eye on the
#  original template file and merge any changes. New Phusion Passenger
#  features may require changes to the template file.
##############################################################

<%= include_passenger_internal_template('global.erb') %>

worker_processes 1;
events {
    worker_connections 4096;
}

http {
    <%= include_passenger_internal_template('http.erb', 4) %>

    ### BEGIN your own configuration options ###
    # This is a good place to put your own config
    # options. Note that your options must not
    # conflict with the ones Passenger already sets.
    # Learn more at:
    # https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template

    ### END your own configuration options ###

    default_type application/octet-stream;
    types_hash_max_size 2048;
    server_names_hash_bucket_size 64;
    client_max_body_size 1024m;
    access_log off;
    keepalive_timeout 60;
    underscores_in_headers on;
    gzip on;
    gzip_comp_level 3;
    gzip_min_length 150;
    gzip_proxied any;
    gzip_types text/plain text/css text/json text/javascript
        application/javascript application/x-javascript application/json
        application/rss+xml application/vnd.ms-fontobject application/x-font-ttf
        application/xml font/opentype image/svg+xml text/xml;

    <% if @app_finder.multi_mode? %>
        # Default server entry for mass deployment mode.
        server {
            <%= include_passenger_internal_template('mass_deployment_default_server.erb', 12) %>
            
            server_tokens off;
            listen 3000 default_server;
            listen [::]:3000 default_server;
            
            # Redirect all HTTP requests to HTTPS with a 301 Moved Permanently response.
            return 301 https://$host:${HTTPS_PORT}$request_uri;
        
        }
    <% end %>

    <% for app in @apps %>
    server {
        <%= include_passenger_internal_template('server.erb', 8, true, binding) %>
        <%= include_passenger_internal_template('rails_asset_pipeline.erb', 8, false) %>

        ### BEGIN your own configuration options ###
        # This is a good place to put your own config
        # options. Note that your options must not
        # conflict with the ones Passenger already sets.
        # Learn more at:
        # https://www.phusionpassenger.com/library/config/standalone/intro.html#nginx-configuration-template

        ssl_certificate <%= app[:ssl_certificate] %>;
        ssl_certificate_key <%= app[:ssl_certificate_key] %>;
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        ssl_prefer_server_ciphers on;
        add_header Strict-Transport-Security max-age=15768000;
        ssl_stapling on;
        ssl_stapling_verify on;
        
        # resolver ;
        ssl_dhparam /usr/src/redmine/ssl/dhparam.pem;
        # ssl_trusted_certificate /usr/src/redmine/ca;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';




        ### END your own configuration options ###
    }
    passenger_pre_start <%= listen_url(app) %>;
    <% end %>

    <%= include_passenger_internal_template('footer.erb', 4) %>
}

EOF


### Plugins

##  Calibre avec More Previews

if [ -d "$root/plugins/redmine_more_previews" ] && [ -d "$root/plugins/redmine_calibre" ]
then

    echo "INFO -- : Redmine More Previews and Calibre plugins found"
    echo  -n "INFO -- : "
    cp -v $root/plugins/redmine_calibre/app/views/repositories/more_preview.html.erb $root/plugins/redmine_more_previews/app/views/repositories/more_preview.html.erb
    echo ""

#    file="$root/plugins/redmine_more_previews/app/views/repositories/more_preview.html.erb"
#    sudo mv $file "$file.old"

#    file="$root/plugins/redmine_more_previews/app/views/attachments/more_preview.html.erb"
#    sudo mv $file "$file.old"

fi

### Calibre avec Xapian Search

#if [ -f "$root/plugins/redmine_xapian/app/views/search/index.html.erb" ] && [ -f "$root/plugins/calibre/app/views/search/index.html.erb" ]
#then
#    echo "Redmine Xapian and Calibre plugins found"

#    file="$root/plugins/redmine_xapian/app/views/search/index.html.erb"
#    sudo mv $file "$file.old"
#fi

## Redmine Emoji

mkdir -p /usr/src/redmine/app/assets/config && echo '{}' > /usr/src/redmine/app/assets/config/manifest.js

## Xapian search

sed -i "s/URI.unescape/CGI.unescape/g" /usr/src/redmine/plugins/redmine_xapian/lib/redmine_xapian/xapian_search.rb


##  Additional
#RUN git clone -b 3.0.5 https://www.github.com/alphanodes/additionals.git plugins/additionals
##  Additional Tags
#RUN git clone -b 1.0.4 https://www.github.com/alphanodes/additional_tags.git plugins/additional_tags


#rake redmine:plugins NAME=redmine_cms  VERSION=0 RAILS_ENV=$env
#rake redmine:plugins NAME=redmineup_tags VERSION=0 RAILS_ENV=$env
#rake redmine:plugins NAME=additionals VERSION=0 RAILS_ENV=$env
#rake redmine:plugins NAME=additional_tags VERSION=0 RAILS_ENV=$env

#rake redmine:plugins NAME=additionals  RAILS_ENV=$env
#rake redmine:plugins NAME=additional_tags  RAILS_ENV=$env

#rm -rfv $root/plugins/redmine_cms
#rm -rfv $root/plugins/redmineup_tags
#rm -rfv $root/plugins/additionals
#rm -rfv $root/plugins/additional_tags



